#!/usr/bin/env python
import os
import sys
import subprocess
import signal
from setup import installer_io

silent = False
if len(sys.argv) == 2 and sys.argv[1]=="-s":
    silent = True
io = installer_io.InstallerIO(silent)

def exit_gracefully(signum, frame):
    print "\ninstall aborted, Cancelled by user"
    sys.exit(1)

def _eula_by_brand():
    filename = ""
    if os.getenv('PIVOTALLABEL') is None:
        filename = 'eula_alpine.txt'
    else:
        filename = 'eula_emc.txt'
    filename = os.path.join(os.path.dirname(os.path.abspath(__file__)), "setup/" + filename)
    with open(filename, 'r') as f:
        eula = f.read();
    return eula

def prompt_for_eula():
    eula = _eula_by_brand()
    print eula
    ret = io.require_confirmation("Do you accept the terms above?")
    if not ret:
        return False
    return True

def run(command):
    p = subprocess.Popen(command, shell=True, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    stdout, stderr = p.communicate()
    return p.returncode, stdout, stderr

def output(msg):
    print "INFO : " + msg

def install():
    if not prompt_for_eula():
        print "install aborted, Cancelled by user"
        return
    user = io.prompt("which user do you want to use to install chorus[default: chorus]", default="chorus")
    ret, stdout, stderr = run("useradd chorus")
    if ret not in [0,9]:
        raise Exception("[ERROR] " + stderr)
    chorus_path = io.prompt("Please enter the full path to the Chorus installation directory[default: /usr/local/chorus]", default="/usr/local/chorus")
    data_path = io.prompt("Please enter the full path to the Chorus data directory (recommended 500GB)[default:/data/chorus]", default="/data/chorus")
    output("Puting chorus to chorus and data path...")
    ret, stdout, stderr = run("mkdir -p %s && mkdir -p %s" % (chorus_path, data_path))
    if ret != 0:
        raise Exception("[ERROR] " + stderr)
    installation_path = os.path.join(os.path.dirname(__file__), "..")
    version = ""
    with open(os.path.join(installation_path, "version_build"), "r") as f:
        version = f.read().strip()

    ret, stdout, stderr = run("cp -rf %s %s" % (os.path.join(installation_path, "version_build"), chorus_path))
    if ret != 0:
        raise Exception("[ERROR] " + stderr)
    release_path = os.path.join(chorus_path, "releases/%s" % version)
    ret, stdout, stderr = run("mkdir -p %s && cp -rf %s %s" % (release_path, installation_path, release_path))
    if ret != 0:
        raise Exception("[ERROR] " + stderr)
    output("."*60 + "[Done]")
    output("change %s's owner to %s..." % (chorus_path, user))
    ret, stdout, stderr = run("chown -R %s:%s %s && chown -R %s:%s %s" % (user, user, chorus_path, user, user, data_path))
    if ret != 0:
        raise Exception("[ERROR] " + stderr)
    output("."*60 + "[Done]")
    _s = ""
    if silent:
        _s = "-s"
    os.system("su - %s -c \"%s setup %s --chorus_path=%s --data_path=%s\"" % (user, os.path.join(release_path, "packaging/setup/chorus_server"), _s, chorus_path, data_path))

try:
    signal.signal(signal.SIGINT, exit_gracefully)
    install()
except Exception as e:
    print e
